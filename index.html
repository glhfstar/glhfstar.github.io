<!doctype html>



  


<html class="theme-next muse use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.0" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Hexo, NexT" />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.0" />






<meta property="og:type" content="website">
<meta property="og:title" content="glhfstar 博客">
<meta property="og:url" content="http://yoursite.com/index.html">
<meta property="og:site_name" content="glhfstar 博客">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="glhfstar 博客">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    sidebar: {"position":"left","display":"post","offset":12,"offset_float":0,"b2t":false,"scrollpercent":false},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/"/>





  <title> glhfstar 博客 </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  














  
  
    
  

  <div class="container sidebar-position-left 
   page-home 
 ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">glhfstar 博客</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2016/10/31/dispatch-once死锁/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="glhfstar">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/icon.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="glhfstar 博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/10/31/dispatch-once死锁/" itemprop="url">
                  dispatch_once死锁
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2016-10-31T16:00:30+08:00">
                2016-10-31
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>在iOS开发中，我们经常会使用到单例，现在Objective-C中写单例的标配是使用dispatch_once。相信这个函数的意义大家都非常清楚了，就是希望dispatch_once参数中的block在全局只执行一次。</p>
<p>不过，有时稍微不留意便会出现问题，比如下面这段代码？</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">Test</span></span></div><div class="line"></div><div class="line">+(Test *)shareInstance</div><div class="line">&#123;</div><div class="line">    <span class="keyword">static</span> Test *test= <span class="literal">nil</span>;</div><div class="line">    <span class="keyword">static</span> <span class="built_in">dispatch_once_t</span> token;</div><div class="line"></div><div class="line">    <span class="built_in">dispatch_once</span>(&amp;token, ^&#123;</div><div class="line"></div><div class="line">        test = [[Test alloc]init];</div><div class="line">    &#125;);</div><div class="line"></div><div class="line">    <span class="keyword">return</span> test;</div><div class="line">&#125;</div><div class="line"></div><div class="line">-(<span class="keyword">instancetype</span>)init</div><div class="line">&#123;</div><div class="line">    <span class="keyword">self</span> = [<span class="keyword">super</span> init];</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (<span class="keyword">self</span>) &#123;</div><div class="line"></div><div class="line">        [Test shareInstance];</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> <span class="keyword">self</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">@end</span></div></pre></td></tr></table></figure>
<p>当我们创建Test([[Test alloc] init])对象时,会出现什么现象呢？死锁。是的，死锁，线程直接卡住了。为什么呢？<br>现在暂停程序，查看调用栈的状态如下图所示：<br><img src="https://raw.githubusercontent.com/glhfstar/glhfstar.github.io/hexo/source/images/dispatch_once.png" alt="avatar"></p>
<p>发现程序是卡在dispatch_once_f中。研究一下dispatch_once_f的实现吧，如下代码所示，会发现一些有意思的东西。</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">void</span></div><div class="line">dispatch_once_f(<span class="built_in">dispatch_once_t</span> *val, <span class="keyword">void</span> *ctxt, dispatch_function_t func)</div><div class="line">&#123;</div><div class="line">	<span class="keyword">struct</span> _dispatch_once_waiter_s * <span class="keyword">volatile</span> *vval =</div><div class="line">			(<span class="keyword">struct</span> _dispatch_once_waiter_s**)val;</div><div class="line">	<span class="keyword">struct</span> _dispatch_once_waiter_s dow = &#123; <span class="literal">NULL</span>, <span class="number">0</span> &#125;;</div><div class="line">	<span class="keyword">struct</span> _dispatch_once_waiter_s *tail, *tmp;</div><div class="line">	_dispatch_thread_semaphore_t sema;</div><div class="line">	<span class="keyword">if</span> (dispatch_atomic_cmpxchg(vval, <span class="literal">NULL</span>, &amp;dow)) &#123;</div><div class="line">		dispatch_atomic_acquire_barrier();</div><div class="line">		_dispatch_client_callout(ctxt, func);</div><div class="line">		dispatch_atomic_maximally_synchronizing_barrier();</div><div class="line">		<span class="comment">//dispatch_atomic_release_barrier(); // assumed contained in above</span></div><div class="line">		tmp = dispatch_atomic_xchg(vval, DISPATCH_ONCE_DONE);</div><div class="line">		tail = &amp;dow;</div><div class="line">		<span class="keyword">while</span> (tail != tmp) &#123;</div><div class="line">			<span class="keyword">while</span> (!tmp-&gt;dow_next) &#123;</div><div class="line">				_dispatch_hardware_pause();</div><div class="line">			&#125;</div><div class="line">			sema = tmp-&gt;dow_sema;</div><div class="line">			tmp = (<span class="keyword">struct</span> _dispatch_once_waiter_s*)tmp-&gt;dow_next;</div><div class="line">			_dispatch_thread_semaphore_signal(sema);</div><div class="line">		&#125;</div><div class="line">	&#125; <span class="keyword">else</span> &#123;</div><div class="line">		dow.dow_sema = _dispatch_get_thread_semaphore();</div><div class="line">		<span class="keyword">for</span> (;;) &#123;</div><div class="line">			tmp = *vval;</div><div class="line">			<span class="keyword">if</span> (tmp == DISPATCH_ONCE_DONE) &#123;</div><div class="line">				<span class="keyword">break</span>;</div><div class="line">			&#125;</div><div class="line">			dispatch_atomic_store_barrier();</div><div class="line">			<span class="keyword">if</span> (dispatch_atomic_cmpxchg(vval, tmp, &amp;dow)) &#123;</div><div class="line">				dow.dow_next = tmp;</div><div class="line">				_dispatch_thread_semaphore_wait(dow.dow_sema);</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">		_dispatch_put_thread_semaphore(dow.dow_sema);</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>简单描述一下吧。onceToken在第一次执行block之前，其值将由NULL变为指向第一个调用者的指针(&amp;dow)。如果在block完成之前，有其它的调用者进来，则会把这些调用者放到一个waiter链表中(走else分支)，直到block执行完成。waiter链中的每个调用者都会等待一个信号量(dow.dow_sema)。在block执行完成后，除了将onceToken置为DISPATCH_ONCE_DONE外，还会去遍历waiter链中的所有waiter，抛出相应的信号量，以告知waiter们调用结束。</p>
<p>因此上面的死锁问题就好理解了。递归调用[[Test alloc] init]时，第二次调用作为一个waiter，在等待block完成，而block的完成依赖于[[Test alloc] init]的执行完成，这就成了一个死锁。</p>
<p>所以应该避免在dispatch_once做递归调用，不管是直接的还是间接的。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2016/06/01/iOS建造者模式/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="glhfstar">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/icon.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="glhfstar 博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/06/01/iOS建造者模式/" itemprop="url">
                  iOS建造者模式
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2016-06-01T11:29:22+08:00">
                2016-06-01
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>生成器模式（Builder）：将一个复杂对象的构建与它的表现分离，使得同样的构建过程可以创建不同的表现。<br>有时，构建某些对象有多种不同方式。如果这些逻辑包含在构建这些对象的类的单一方法中，代码将会充满条件判断。如果能把构建过程分解为客户-指导者-生成器(client-director-builder)的关系，那么过程将更容易管理与服用。针对此类关系的设计模式成为生成器。</p>
<p>我们们先来看个例子，假设你现在要买一辆车，提出以下一堆要求：红色、10万左右、国产、5座等等，代码如下：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">Car *car = [[Car alloc] init];</div><div class="line">car.color = [<span class="built_in">UIColor</span> whiteColor];</div><div class="line">car.price = <span class="number">100000</span>;</div><div class="line">car.family = <span class="string">@"China"</span>;</div><div class="line">car.seatCount = <span class="number">5</span>;</div></pre></td></tr></table></figure>
<p>或者是这样：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Car *car = [Car alloc] initWithColor:[<span class="built_in">UIColor</span> whiteColor] price:<span class="number">100000</span> family:<span class="string">@"China"</span> seatCount:<span class="number">5</span> ....];</div></pre></td></tr></table></figure>
<p>第一种方式可扩展性好些，但无法约束必须设置某些 property。第二种方式修正了这个问题，但扩展性也差了。<br>假如又有了新需求，要让客户可以选择汽车的驱动方式，。对于第一种，自然可以新增一个属性，但使用者很可能完全不知道新增了这么个属性。对于第二种，则只能再新建一个初始化方式，如 -[initWithColor: price:family:seatCount:actuate]。那如果又有新的需求，比如选择汽车的排量？或者可以选择车身结构等等。这两种方式都不能很好地处理需求的变更。</p>
<p>所以，当某个类的属性值很多时，我们可以考虑使用建造者模式Builder Pattern来让初始化过程清晰一些。代码大概是这样的：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">Car *car = [Car  createWithBuilder:^(CarBuilder *builder)&#123;</div><div class="line">	builder.color = [<span class="built_in">UIColor</span> whiteColor];</div><div class="line">	builder.price = <span class="number">100000</span>;</div><div class="line">	builder.family = <span class="string">@"China"</span>;</div><div class="line">	builder.seatCount = <span class="number">5</span>;</div><div class="line">&#125;];</div><div class="line"></div><div class="line"></div><div class="line">+ (<span class="keyword">instancetype</span>)createWithBuilder:(BuilderBlock)block &#123;</div><div class="line">	<span class="built_in">NSParameterAssert</span>(block);</div><div class="line">	CarBuilder *builder = [[CarBuilder alloc] init];</div><div class="line">	block(builder);</div><div class="line">	<span class="keyword">return</span> [builder build];</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>build的实现方式如下代码：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">- (Car *)build</div><div class="line">&#123;</div><div class="line">	<span class="comment">// 可以在这里对 property 做检查</span></div><div class="line">	<span class="built_in">NSAssert</span>(<span class="keyword">self</span>.price, <span class="string">@"请填写价格"</span>);</div><div class="line"></div><div class="line">	Car * car = [[Car alloc] init];</div><div class="line">	car.color = <span class="keyword">self</span>.color;</div><div class="line">	car.price = <span class="keyword">self</span>.price;</div><div class="line">	car.family = <span class="keyword">self</span>.family;</div><div class="line">	car.seatCount = <span class="keyword">self</span>.seatCount;</div><div class="line"></div><div class="line">	<span class="keyword">return</span> car;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>在FaceBook的开源动画框架POP中也有对builder pattern类似的应用：<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">POPAnimatableProperty *animatableProperty = [POPAnimatableProperty propertyWithName:<span class="string">@"property"</span> initializer:^(POPMutableAnimatableProperty *prop) &#123;</div><div class="line">    prop.writeBlock = ^(<span class="keyword">id</span> obj, <span class="keyword">const</span> <span class="built_in">CGFloat</span> values[]) &#123;</div><div class="line">    &#125;;</div><div class="line">    prop.readBlock = ^(<span class="keyword">id</span> obj, <span class="built_in">CGFloat</span> values[]) &#123;</div><div class="line">    &#125;;</div><div class="line">&#125;];</div></pre></td></tr></table></figure></p>
<p>这里的 initializer 其实就是 builder。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2016/05/08/swift-map函数/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="glhfstar">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/icon.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="glhfstar 博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/05/08/swift-map函数/" itemprop="url">
                  swift map函数
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2016-05-08T16:59:33+08:00">
                2016-05-08
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>跟其它一些语言里的map函数一样，swift map函数能够被数组调用，它接受一个闭包作为参数，作用于数组中的每个元素。闭包返回一个变换后的元素，接着将所有这些变换后的元素组成一个新的数组.</p>
<p>比如我们有个这样的需求，遍历一个数组中所有的元素，将每个元素乘以5，最后返回一个保存相加后元素的数组。可以这样使用：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">let arr = [<span class="number">2</span>,<span class="number">5</span>]</div><div class="line">let multiplication = arr.map&#123;</div><div class="line">    $<span class="number">0</span> * <span class="number">5</span></div><div class="line">&#125;</div><div class="line"></div><div class="line">print(doubled)</div><div class="line"><span class="comment">// 输出：</span></div><div class="line"><span class="comment">// [10,50]</span></div></pre></td></tr></table></figure>
<p>这样很方便，可以让我们省去了一些代码，看起来也很简洁。</p>
<p>现在假设我们有个需求，要将某个 Int? 乘 5。按照一般的思路，我们可以采用if-let方式实现这个需求。我们可以写出如下代码：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">let num: Int? = <span class="number">5</span></div><div class="line"></div><div class="line">var multiplication: Int?</div><div class="line"><span class="keyword">if</span> let number = num &#123;</div><div class="line">    multiplication = number * <span class="number">5</span></div><div class="line">&#125; <span class="keyword">else</span> &#123;</div><div class="line">    multiplication = <span class="literal">nil</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>其实有一种更加简洁优雅的方式，那就是使用 Optional 的 map。swift中的map 函数不仅可以在Array或CollectionType中使用，也可以在Optional 类型中使用。我们先看下Optional的声明代码：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">public <span class="keyword">enum</span> Optional&lt;T&gt; :</div><div class="line">    _Reflectable, NilLiteralConvertible &#123;</div><div class="line"></div><div class="line">    <span class="comment">//...</span></div><div class="line"></div><div class="line">    <span class="comment">/// If `self == nil`, returns `nil`.  Otherwise, returns `f(self!)`.</span></div><div class="line">    public func map&lt;U&gt;(@noescape f: (T) -&gt; U) -&gt; U?</div><div class="line"></div><div class="line">    <span class="comment">//...</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这个方法能让我们很方便地对一个 Optional 值做变化和操作，而不必进行手动的解包工作。输入会被自动用类似 Optinal Binding 的方式进行判断，如果有值，则进入 f 的闭包进行变换，并返回一个 U?；如果输入就是 nil 的话，则直接返回值为 nil 的 U?。</p>
<p>根据这个方法的原理，可以对上面的代码进行如下修改：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">let num: Int? = <span class="number">5</span></div><div class="line">let multiplication = num.map &#123;</div><div class="line">    $<span class="number">0</span> * <span class="number">5</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// multiplication 为 25</span></div></pre></td></tr></table></figure>
          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2016/04/08/iOS-抽象工厂模式/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="glhfstar">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/icon.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="glhfstar 博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/04/08/iOS-抽象工厂模式/" itemprop="url">
                  iOS 抽象工厂模式
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2016-04-08T21:04:25+08:00">
                2016-04-08
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>抽象工厂模式提供了一种方式，可以将一组具有同一主题的单独的工厂封装起来。在正常使用中，客户端程序需要创建抽象工厂的具体实现，然后使用抽象工厂作为接口来创建这一主题的具体对象。客户端程序不需要知道（或关心）它从这些内部的工厂方法中获得对象的具体类型，因为客户端程序仅使用这些对象的通用接口。抽象工厂模式将一组对象的实现细节与他们的一般使用分离开来。</p>
<font color="red"><strong>iOS 类簇使用的便是抽象工厂的设计模式，像NSNumber, NSDictionary.例如在NSNumber的初始化伪代码大概像这样：</strong></font>

<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">- (<span class="keyword">id</span>)initWithBool</div><div class="line">&#123;</div><div class="line">	<span class="keyword">return</span> [[__NSCFBoolean alloc]init];</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (<span class="keyword">id</span>)initWithLong</div><div class="line">&#123;</div><div class="line">	<span class="keyword">return</span> [[__NSCFNumber alloc]init];</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>在iOS 开发中，我们可以利用这种设计模式将若干抽象产品的接口与不同主题产品的具体实现分离开。这样就能在增加新的具体工厂的时候，不用修改引用抽象工厂的客户端代码。<br>下面用一个例子来实现抽象工厂的模式：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//  KSStorage.h</span></div><div class="line"></div><div class="line"><span class="meta">#import <span class="meta-string">&lt;Foundation/Foundation.h&gt;</span></span></div><div class="line"></div><div class="line"><span class="keyword">typedef</span> <span class="built_in">NS_ENUM</span>(<span class="built_in">NSInteger</span>, DataType) &#123;</div><div class="line">    FileStorageDataType,</div><div class="line">    DatabaseStorageDataType,</div><div class="line">&#125;;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">@protocol</span> <span class="title">KSStorageProtocol</span> </span></div><div class="line"><span class="keyword">@required</span></div><div class="line">    -(<span class="keyword">void</span>)saveData;</div><div class="line">    -(<span class="keyword">id</span>)initWithData:(<span class="built_in">NSData</span> *)data;</div><div class="line"><span class="keyword">@end</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">KSStorage</span> : <span class="title">NSObject</span> &lt;<span class="title">KSStorageProtocol</span>&gt;</span></div><div class="line">-(<span class="keyword">id</span>)initWithData:(<span class="built_in">NSData</span> *)data type:(DataType)dataType;</div><div class="line"><span class="keyword">@end</span></div></pre></td></tr></table></figure>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//  KSStorage.m</span></div><div class="line"></div><div class="line"><span class="meta">#import <span class="meta-string">"KSStorage.h"</span></span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">FileStorage</span> : <span class="title">KSStorage</span></span></div><div class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>,<span class="keyword">strong</span>) <span class="built_in">NSURL</span>  *storageURL;</div><div class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>,<span class="keyword">strong</span>) <span class="built_in">NSData</span> *data;</div><div class="line"></div><div class="line"><span class="keyword">@end</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">DatabaseStorage</span> : <span class="title">KSStorage</span></span></div><div class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>,<span class="keyword">strong</span>) <span class="built_in">NSDictionary</span>  *dbConnectionInformationDictionary;</div><div class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>,<span class="keyword">strong</span>) <span class="built_in">NSData</span> *data;</div><div class="line"></div><div class="line"><span class="keyword">@end</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">KSStorage</span></span></div><div class="line"></div><div class="line">-(<span class="keyword">id</span>)initWithData:(<span class="built_in">NSData</span> *)data type:(DataType)dataType&#123;</div><div class="line">    <span class="keyword">self</span> = <span class="literal">nil</span>;</div><div class="line">    <span class="keyword">if</span> (dataType == FileStorageDataType)&#123;</div><div class="line">        <span class="keyword">self</span> = [[FileStorage alloc] initWithData:data];</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (dataType == DatabaseStorageDataType)&#123;</div><div class="line">        <span class="keyword">self</span> = [[DatabaseStorage alloc] initWithData:data];</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">self</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line">-(<span class="keyword">void</span>)saveData&#123;</div><div class="line">    [<span class="built_in">NSException</span> raise:<span class="built_in">NSInternalInconsistencyException</span></div><div class="line">                format:<span class="string">@"You have not implemented %@ in %@"</span>, <span class="built_in">NSStringFromSelector</span>(_cmd), <span class="built_in">NSStringFromClass</span>([<span class="keyword">self</span> <span class="keyword">class</span>])];</div><div class="line">&#125;</div><div class="line"></div><div class="line">-(<span class="keyword">id</span>)initWithData:(<span class="built_in">NSData</span> *)data&#123;</div><div class="line">    [<span class="built_in">NSException</span> raise:<span class="built_in">NSInternalInconsistencyException</span></div><div class="line">                format:<span class="string">@"You have not implemented %@ in %@"</span>, <span class="built_in">NSStringFromSelector</span>(_cmd), <span class="built_in">NSStringFromClass</span>([<span class="keyword">self</span> <span class="keyword">class</span>])];</div><div class="line">    <span class="keyword">return</span> <span class="literal">nil</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">@end</span></div><div class="line"></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">FileStorage</span></span></div><div class="line"></div><div class="line">-(<span class="keyword">id</span>)initWithData:(<span class="built_in">NSData</span> *)data&#123;</div><div class="line">    <span class="keyword">self</span>.data = data;</div><div class="line">    <span class="keyword">self</span>.storageURL = [<span class="built_in">NSURL</span> URLWithString:<span class="string">@"file:///Users/debasisdas/Knowstack/SampleData.txt"</span>];</div><div class="line">    <span class="keyword">return</span> <span class="keyword">self</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line">-(<span class="keyword">void</span>)saveData&#123;</div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"data is %@"</span>,<span class="keyword">self</span>.data);</div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"Now store it to stated URL %@"</span>,<span class="keyword">self</span>.storageURL);</div><div class="line">&#125;</div><div class="line"><span class="keyword">@end</span></div><div class="line"></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">DatabaseStorage</span></span></div><div class="line"></div><div class="line">-(<span class="keyword">id</span>)initWithData:(<span class="built_in">NSData</span> *)data&#123;</div><div class="line">    <span class="keyword">self</span>.data = data;</div><div class="line">    <span class="keyword">self</span>.dbConnectionInformationDictionary = @&#123;<span class="string">@"connection"</span>:<span class="string">@"xyz.domain.com"</span>,<span class="string">@"port"</span>:<span class="string">@"8080"</span>,<span class="string">@"password"</span>:<span class="string">@"*******"</span>&#125;;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">self</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line">-(<span class="keyword">void</span>)saveData</div><div class="line">&#123;</div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"data is %@"</span>,<span class="keyword">self</span>.data);</div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"Now store it to stated URL %@"</span>,<span class="keyword">self</span>.dbConnectionInformationDictionary);</div><div class="line"></div><div class="line">&#125;</div><div class="line"><span class="keyword">@end</span></div></pre></td></tr></table></figure>
<p>测试代码：<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">NSString</span> *sampleString = <span class="string">@"This is a sample string"</span>;</div><div class="line"><span class="built_in">NSData</span> *data = [sampleString dataUsingEncoding:<span class="built_in">NSUTF8StringEncoding</span>];</div><div class="line">KSStorage *storage1 = [[KSStorage alloc] initWithData:data type:FileStorageDataType];</div><div class="line"><span class="built_in">NSLog</span>(<span class="string">@"storage1 %@"</span>,storage1);</div><div class="line"><span class="keyword">if</span> ([storage1 respondsToSelector:<span class="keyword">@selector</span>(saveData)])&#123;</div><div class="line">    [storage1 saveData];</div><div class="line">&#125;</div><div class="line"></div><div class="line">KSStorage *storage2 = [[KSStorage alloc] initWithData:data type:DatabaseStorageDataType];</div><div class="line"><span class="built_in">NSLog</span>(<span class="string">@"storage2 %@"</span>,storage2);</div><div class="line"><span class="keyword">if</span> ([storage2 respondsToSelector:<span class="keyword">@selector</span>(saveData)])&#123;</div><div class="line">    [storage2 saveData];</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2016/04/02/SQLite数据库升级处理/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="glhfstar">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/icon.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="glhfstar 博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/04/02/SQLite数据库升级处理/" itemprop="url">
                  SQLite数据库升级处理
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2016-04-02T21:22:44+08:00">
                2016-04-02
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><strong>在app开发过程中，如果本地存储采用了SQLite。那么当app有新的需求时需要更改本地数据库的结构，比如说增加新的字段或者删除原有的字段。此时，如果没有采取正确的措施，会导致升级后的app进行数据存储时发生异常。</strong><br><strong>接下来介绍下如何处理数据库结构变化所导致的问题。</strong></p>
<h3 id="增加字段"><a href="#增加字段" class="headerlink" title="增加字段"></a>增加字段</h3><p>比如在原有的版本上增加一个<code>new</code>字段.先判断当前的数据库表中是否已经包含<code>new</code>字段，如果没有则为当前数据库表插入字段。</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span> (![fmdb columnExists:<span class="string">@"new"</span> inTableWithName:<span class="string">@"app"</span>]) &#123;</div><div class="line">            <span class="built_in">NSString</span> *alertStr = [<span class="built_in">NSString</span> stringWithFormat:<span class="string">@"alter table %@ add %@ varchar"</span>,<span class="string">@"app"</span>,<span class="string">@"new"</span>];</div><div class="line">            <span class="built_in">BOOL</span> isSucess = [fmdb executeUpdate:alertStr];</div><div class="line">            <span class="keyword">if</span> (isSucess) &#123;</div><div class="line"></div><div class="line">            &#125;<span class="keyword">else</span>&#123;</div><div class="line">                </div><div class="line">            &#125;</div><div class="line">        &#125;</div></pre></td></tr></table></figure>
<h3 id="删除字段"><a href="#删除字段" class="headerlink" title="删除字段"></a>删除字段</h3><p>由于SQLite 仅仅支持 <code>ALTER TABLE</code> 语句的一部分功能，我们可以用  <code>ALTER TABLE</code> 语句来更改一个表的名字，也可向表中增加一个字段（列），但是我们不能删除一个已经存在的字段，或者更改一个已经存在的字段的名称、数据类型、限定符等等。 </p>
<p>个人觉得有以下两种处理方式：<br><strong>第一种是不修改表的结构，如果只有少量字段不需要使用了，保留着影响也不大。</strong><br><strong>第二种是把原来的数据库表改名为其它，然后新建新的数据库表，接着把旧的数据库表数据重新导入到新的数据库表，最后删掉旧的数据库表。</strong></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2016/03/25/swift如何更好地print/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="glhfstar">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/icon.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="glhfstar 博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/03/25/swift如何更好地print/" itemprop="url">
                  swift如何更好地print
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2016-03-25T16:14:17+08:00">
                2016-03-25
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>打印输出是程序开发中很重要的组成部分，它可以反映我们的程序是如何工作的，以及记录程序运行的过程中发生了什么。在 OC 中默认是使用NSLog 打印, Swift 中默认使用 print打印。 </p>
<p>在OC 中的自定 Log, 一般是定义在.pch 的宏定义文件中, 但是 Swift 中已经没有宏定义文件了。 那么就不能自定义了吗? 其实不是的, 因为 Swift 只要在一个文件中声明了一个公开的方法, 其他文件都是可以访问到的.</p>
<p>普通的log可以输出我们关心的字符串或值。但当项目变得庞大复杂的时候，往往会有特别多的log从控制台输出，此时要找到我们关心的输出并不容易。所以为了更好的了解打印的详情，包括log 的所在文件，调用的行号以及所处的方法名字等等。可以在log的时候把这些信息当作参数进行传递并输出到控制体上。</p>
<p>例如对print进行类似这样的封装：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">func RHPrint&lt;T&gt;(message: T,</div><div class="line">                    file: String = <span class="meta">#file,</span></div><div class="line">                  method: String = <span class="meta">#function,</span></div><div class="line">                    line: Int = <span class="meta">#line)</span></div><div class="line">&#123;</div><div class="line">    print(<span class="string">"\((file as NSString).lastPathComponent)[\(line)], \(method): \(message)"</span>)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这样，在进行 log 的时候我们只需要使用这个方法就能完成文件名，行号以及方法名的输出了。最棒的是，我们不再需要对这样的输出进行维护，无论在哪里它都能正确地输出各个参数：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Test.swift</span></div><div class="line">func method() &#123;</div><div class="line">    <span class="comment">//...</span></div><div class="line">    RHPrint(<span class="string">"这是一条输出"</span>)</div><div class="line">    <span class="comment">//...</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// 输出：</span></div><div class="line"><span class="comment">// Test.swift[62], method(): 这是一条输出</span></div></pre></td></tr></table></figure>
<p>另外，对于 log 输出更多地其实是用在程序开发和调试的过程中的，过多的输出有可能对运行的性能造成影响。在 Release 版本中关闭掉向控制台的输出也是软件开发中一种常见的做法。如果我们在开发中就注意使用了统一的 log 输出的话，这就变得非常简单了。使用条件编译的方法，我们可以添加条件，并设置合适的编译配置，使 RHPrint 的内容在 Release 时被去掉，从而成为一个空方法：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">func RHPrint&lt;T&gt;(message: T,</div><div class="line">                    file: String = <span class="meta">#file,</span></div><div class="line">                  method: String = <span class="meta">#function,</span></div><div class="line">                    line: Int = <span class="meta">#line)</span></div><div class="line">&#123;</div><div class="line">    <span class="meta">#if DEBUG</span></div><div class="line">     print(<span class="string">"\((file as NSString).lastPathComponent)[\(line)], \(method): \(message)"</span>)</div><div class="line">    <span class="meta">#endif</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p> 但这样写之后并不能使用的, 也就是不会执行打印, 还需要在项目配置中修改一下设置, 如下图：<br> <img src="https://raw.githubusercontent.com/glhfstar/glhfstar.github.io/hexo/source/images/RHPrint.png" alt="avatar"></p>
<p> 第3步那里是展开, 第4步在 Debug 后面点击加号, 第5步在出现的方框里填入 -D DEBUG . -D 后面是一个标识, 用来区分是什么模式, 你也可以叫其他名字,  这个标识是和上面自定义调试打印信息里的判断相对应的。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2016/03/20/利用xcode snippet 解决代码块重复敲写的问题/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="glhfstar">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/icon.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="glhfstar 博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/03/20/利用xcode snippet 解决代码块重复敲写的问题/" itemprop="url">
                  利用xcode snippet 解决代码块重复敲写的问题
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2016-03-20T19:28:15+08:00">
                2016-03-20
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>   <strong>当你在写一个tableview时,一般都需要实现它的delegate和datasource时,你是为否有为如何快捷的将那几个常用的方法快速敲打出来而苦恼过,或者你会在别的代码块将那几个常用的方法复制粘贴过来,但是效率上来说其实也不高。是否有一种方法可以像代码提示那样只需几个关键字就能将这好几个的代理方法直接Tab键一按就洋洋洒洒洒落在你眼前呢?<br>   通过xcode snippet便可解决上面提到的那个问题。xcode snippet是一个代码块重复使用管理的功能，通过创建一些可重用的代码块，并且在任何需要的地方很容易的就可以使用这些代码块。这样就可以节省很多输入操作的时间, 从而提高开发的效率。接下来我们就利用snippet 解决上述的问题。 </strong></p>
<p>  <strong>首先, 创建需要重复使用的代码块。然后单击并按住代码块，等文本光标变为箭头光标。接着将代码块拖放到code snippet library中，然后松开鼠标。如下图所示</strong></p>
<p><img src="http://upload-images.jianshu.io/upload_images/2185894-ee8743f5a8439f22.jpeg?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="1.jpeg"></p>
<p>  <strong>此时会弹出一个编辑框，通过编辑框对代码块进行相关的设置，如下图所示。</strong><br>  <br><img src="http://upload-images.jianshu.io/upload_images/2185894-13e7a901489bc586.jpeg?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="2.jpeg"></p>
<p><strong> 设置相关说明:</strong></p>
<ul>
<li>Title：Code Snippets的标题；</li>
<li>Summary：Code Snippets的描述文字；</li>
<li>Platform：可以使用Code Snippets的平台</li>
<li>Language：可以在哪些语言中使用该Code Snippets</li>
<li>Completion Shortcut：Code Snippets的快捷方式，比如这里设置为 “fast tableview”, 当敲写这个关键字符串时就会出现该代码块的提示。</li>
<li>Completion Scopes:可以在哪些文件中使用当前Code Snippets，比如全部位置，头文件中等，当然可以添加多个支持的位置。</li>
<li>最后的一个大得空白区域是对Code Snippets的效果预览。</li>
</ul>
<p>  <strong>现在来试用一下刚刚创建的snippet！有两种方法。<br>第一种是在code snippet library中找到刚刚创建的snippet，然后用鼠标将其拖拽到代码编辑器中,然后松开鼠标就可以了。</strong></p>
<p><img src="http://upload-images.jianshu.io/upload_images/2185894-ffd3b2898d720abb.jpeg?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="3.jpeg"></p>
<p>  <strong>第二种方法是在代码编辑器里输入completion shortcut中设置的内容,这里是“fast tableview”。</strong><br>  <br><img src="http://upload-images.jianshu.io/upload_images/2185894-98fe5a0bbbe1afe9.jpeg?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="4.jpeg"></p>
<p>  <strong>通过xcode snippet对经常使用的代码块进行管理，是不是发现顿时开发效率提高了很多呢。</strong></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2016/03/11/block之变量的存取/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="glhfstar">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/icon.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="glhfstar 博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/03/11/block之变量的存取/" itemprop="url">
                  block之变量的存取
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2016-03-11T20:14:33+08:00">
                2016-03-11
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><strong> Block作为C语言的扩展，并不是高新技术，和其他语言的闭包或lambda表达式是一回事。Block被Obj-C看成是对象，它封装了一段代码，这段代码可以在任何时候执行。Block可以作为函数参数或者函数的返回值，而其本身又可以带输入参数或返回值。它和传统的函数指针很类似，但是有区别：Block是inline的，并且它对局部变量是只读的。</strong></p>
<p><strong> 接下来对Block对变量的访问和修改进行分析。</strong></p>
<h4 id="1-对局部变量的存取"><a href="#1-对局部变量的存取" class="headerlink" title="1.对局部变量的存取"></a>1.对局部变量的存取</h4><p>下面先看代码</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">&#123;    </div><div class="line">    <span class="keyword">int</span> outA = <span class="number">8</span>;    </div><div class="line">    <span class="keyword">int</span> (^myPtr)(<span class="keyword">int</span>) = ^(<span class="keyword">int</span> a)&#123; <span class="keyword">return</span> outA + a;&#125;;    </div><div class="line">    <span class="comment">//block里面可以读取同一类型的outA的值    </span></div><div class="line">    <span class="keyword">int</span> result = myPtr(<span class="number">3</span>);  <span class="comment">// result is 11    </span></div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"result=%d"</span>, result);    </div><div class="line">&#125;  </div></pre></td></tr></table></figure>
<p>当我在调用”int result = myPtr(3);” 之前将outA的值修改为其它值时，result的值是否会改变呢?</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">&#123;    </div><div class="line">    <span class="keyword">int</span> outA = <span class="number">8</span>;    </div><div class="line">    <span class="keyword">int</span> (^myPtr)(<span class="keyword">int</span>) = ^(<span class="keyword">int</span> a)&#123; <span class="keyword">return</span> outA + a;&#125;; <span class="comment">//block里面可以读取同一类型的outA的值    </span></div><div class="line">        </div><div class="line">    outA = <span class="number">5</span>;  <span class="comment">//在调用myPtr之前改变outA的值    </span></div><div class="line">    <span class="keyword">int</span> result = myPtr(<span class="number">3</span>);  <span class="comment">// result的值仍然是11，并不是8    </span></div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"result=%d"</span>, result);    </div><div class="line">&#125;  </div></pre></td></tr></table></figure>
<p>为什么result 的值仍然是11？而不是8呢？事实上，myPtr在其主体中用到的outA这个变量值的时候做了一个copy的动作，把outA的值copy下来。所以，之后outA即使换成了新的值，对于myPtr里面copy的值是没有影响的。<br>需要注意的是，这里copy的值是变量的值，如果它是一个记忆体的位置（地址），换句话说，就是这个变量是个指针的话，</p>
<p>它的值是可以在block里被改变的。如下例子：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">&#123;    </div><div class="line">    <span class="built_in">NSMutableArray</span> *mutableArray = [<span class="built_in">NSMutableArray</span> arrayWithObjects:<span class="string">@"one"</span>, <span class="string">@"two"</span>, <span class="string">@"three"</span>, <span class="literal">nil</span> <span class="literal">nil</span>];    </div><div class="line">    <span class="keyword">int</span> result = ^(<span class="keyword">int</span> a)&#123;[mutableArray removeLastObject]; <span class="keyword">return</span> a*a;&#125;(<span class="number">5</span>);    </div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"test array :%@"</span>, mutableArray);    </div><div class="line">&#125;  </div></pre></td></tr></table></figure>
<p>原本mutableArray的值是{@”one”,@”two”,@”three”}，在block里面被更改mutableArray后，就变成{@”one”, @”two”}了。</p>
<h4 id="2-对static类型修饰的变量的存取"><a href="#2-对static类型修饰的变量的存取" class="headerlink" title="2.对static类型修饰的变量的存取"></a>2.对static类型修饰的变量的存取</h4><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">&#123;    </div><div class="line">    <span class="keyword">static</span> <span class="keyword">int</span> outA = <span class="number">8</span>;    </div><div class="line">    <span class="keyword">int</span> (^myPtr)(<span class="keyword">int</span>) = ^(<span class="keyword">int</span> a)&#123;<span class="keyword">return</span> outA + a;&#125;;    </div><div class="line">    outA = <span class="number">5</span>;    </div><div class="line">    <span class="keyword">int</span> result = myPtr(<span class="number">3</span>);  <span class="comment">//result的值是8，因为outA是static类型的变量    </span></div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"result=%d"</span>, result);      </div><div class="line">&#125; </div></pre></td></tr></table></figure>
<p>甚至可以直接在block里面修改outA的值，例如下面的写法：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">&#123;    </div><div class="line">    <span class="keyword">static</span> <span class="keyword">int</span> outA = <span class="number">8</span>;    </div><div class="line">    <span class="keyword">int</span> (^myPtr)(<span class="keyword">int</span>) = ^(<span class="keyword">int</span> a)&#123; outA = <span class="number">5</span>; <span class="keyword">return</span> outA + a;&#125;;    </div><div class="line">    <span class="keyword">int</span> result = myPtr(<span class="number">3</span>);  <span class="comment">//result的值是8，因为outA是static类型的变量    </span></div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"result=%d"</span>, result);    </div><div class="line">&#125;  </div><div class="line"></div></pre></td></tr></table></figure>
<h4 id="3-对-block类型修饰的变量的存取"><a href="#3-对-block类型修饰的变量的存取" class="headerlink" title="3. 对__block类型修饰的变量的存取"></a>3. 对__block类型修饰的变量的存取</h4><p>在某个变量前面如果加上修饰字“__block”的话（注意，block前面有两个下划线），那么在block里面就可以任意修改此变量的值，如下代码：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">&#123;    </div><div class="line">    __block <span class="keyword">int</span> num = <span class="number">5</span>;    </div><div class="line">    <span class="keyword">int</span> (^myPtr)(<span class="keyword">int</span>) = ^(<span class="keyword">int</span> a)&#123;<span class="keyword">return</span> num++;&#125;;    </div><div class="line">    <span class="keyword">int</span> (^myPtr2)(<span class="keyword">int</span>) = ^(<span class="keyword">int</span> a)&#123;<span class="keyword">return</span> num++;&#125;;    </div><div class="line">    <span class="keyword">int</span> result = myPtr(<span class="number">0</span>);   <span class="comment">//result的值为5，num的值为6    </span></div><div class="line">    result = myPtr2(<span class="number">0</span>);      <span class="comment">//result的值为6，num的值为7    </span></div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"result=%d"</span>, result);     </div><div class="line">&#125;  </div></pre></td></tr></table></figure>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
  </section>

  


          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel sidebar-panel-active">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/icon.jpg"
               alt="glhfstar" />
          <p class="site-author-name" itemprop="name">glhfstar</p>
           
              <p class="site-description motion-element" itemprop="description"></p>
          
        </div>
        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
              <a href="/archives">
                <span class="site-state-item-count">8</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          

          

        </nav>

        

        <div class="links-of-author motion-element">
          
        </div>

        
        

        
        

        


      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2017</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">glhfstar</span>
</div>


<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Muse
  </a>
</div>


        

        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  






  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.0"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.0"></script>



  


  




	





  





  





  






  





  

  

  

  

</body>
</html>
